# .github/workflows/api_ci.yml
# This file defines the Continuous Integration workflow for your API Automation project.

name: RestAssured API CI Suite

on:
  # 1. Automated Run: Triggers on every push or PR to main/master branches
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  
  # 2. Manual Run: Allows you to manually trigger a run against a specific environment/URL from the GitHub UI.
  workflow_dispatch:
    inputs:
      api_url:
        description: 'Target API Base URL (Override Default)'
        required: false
        # The specified default base URL
        default: 'https://api.stage.us-east-2.api.revdoc.link' 
        type: string

jobs:
  execute_api_tests:
    name: Execute RestAssured Tests
    runs-on: ubuntu-latest
    
    # ----------------------------------------------------------------------------------
    # Environment Variables (Injected into your Java Test Code)
    # ----------------------------------------------------------------------------------
    env:
      # Sets the API URL which BaseTest.java will read via System.getenv("API_BASE_URL")
      API_BASE_URL: ${{ github.event.inputs.api_url || 'https://api.stage.us-east-2.api.revdoc.link' }}

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    # Step 1: Setup Java environment
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven 

    # Step 2: Compile the project artifacts (skip tests here)
    - name: Compile Project Artifact
      run: mvn clean install -DskipTests -B
      
    # Step 3: Execute ALL API Tests (Running Full Suite)
    - name: Execute API Tests (Running Full Suite)
      run: mvn test -B
      
    # Step 4: Publish Test Results 
    - name: Publish Test Results to GitHub
      # Using the stable v1.7.0 version of the action
      uses: dorny/test-reporter@v1.7.0 
      if: always() # Ensures reports are published even if a test failed
      with:
        name: API TestNG Results
        path: target/surefire-reports/*.xml 
        # FIX: Corrected the value from 'surefire' to the required 'maven-surefire'
        reporter: maven-surefire 
        fail-on-error: true 
        
    # Step 5: Upload Test Reports as an Artifact
    - name: Upload Test Reports Artifact
      uses: actions/upload-artifact@v4
      with:
        name: api-test-reports-artifact
        path: target/surefire-reports
        retention-days: 7